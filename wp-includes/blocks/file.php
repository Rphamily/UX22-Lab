<?php
 function render_block_core_file( $attributes, $content, $block ) { $should_load_view_script = ! empty( $attributes['displayPreview'] ); $view_js_file = 'wp-block-file-view'; if ( ! wp_script_is( $view_js_file ) ) { $script_handles = $block->block_type->view_script_handles; if ( ! $should_load_view_script && in_array( $view_js_file, $script_handles, true ) ) { $block->block_type->view_script_handles = array_diff( $script_handles, array( $view_js_file ) ); } if ( $should_load_view_script && ! in_array( $view_js_file, $script_handles, true ) ) { $block->block_type->view_script_handles = array_merge( $script_handles, array( $view_js_file ) ); } } $pattern = '@<object.+(?<attribute>aria-label="(?<filename>[^"]+)?")@i'; $content = preg_replace_callback( $pattern, static function ( $matches ) { $filename = ! empty( $matches['filename'] ) ? $matches['filename'] : ''; $has_filename = ! empty( $filename ) && 'PDF embed' !== $filename; $label = $has_filename ? sprintf( __( 'Embed of %s.' ), $filename ) : __( 'PDF embed' ); return str_replace( $matches['attribute'], sprintf( 'aria-label="%s"', $label ), $matches[0] ); }, $content ); if ( $should_load_view_script ) { $processor = new WP_HTML_Tag_Processor( $content ); $processor->next_tag(); $processor->set_attribute( 'data-wp-interactive', '' ); $processor->next_tag( 'object' ); $processor->set_attribute( 'data-wp-bind--hidden', '!selectors.core.file.hasPdfPreview' ); $processor->set_attribute( 'hidden', true ); return $processor->get_updated_html(); } return $content; } function block_core_file_ensure_interactivity_dependency() { global $wp_scripts; if ( isset( $wp_scripts->registered['wp-block-file-view'] ) && ! in_array( 'wp-interactivity', $wp_scripts->registered['wp-block-file-view']->deps, true ) ) { $wp_scripts->registered['wp-block-file-view']->deps[] = 'wp-interactivity'; } } add_action( 'wp_print_scripts', 'block_core_file_ensure_interactivity_dependency' ); function register_block_core_file() { register_block_type_from_metadata( __DIR__ . '/file', array( 'render_callback' => 'render_block_core_file', ) ); } add_action( 'init', 'register_block_core_file' ); 